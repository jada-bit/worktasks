<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Worklog Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for table */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Calendar Specific Styles */
        .calendar-grid-line { border-top: 1px solid #e2e8f0; }
        .calendar-grid-line-minor { border-top: 1px dashed #f1f5f9; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                <i data-lucide="briefcase" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-900 leading-none">Executive Worklog</h1>
                <p class="text-xs text-slate-500 mt-1">Track. Analyze. Report.</p>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- Hidden File Input for Import -->
            <input type="file" id="importInput" class="hidden" accept=".csv" onchange="importCSV(this)">
            
            <button onclick="document.getElementById('importInput').click()" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 hover:text-indigo-600 hover:bg-slate-50 rounded-md transition-colors" title="Import from CSV backup">
                <i data-lucide="upload" class="w-4 h-4"></i>
                Import CSV
            </button>
            <button onclick="exportCSV()" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 hover:text-indigo-600 hover:bg-slate-50 rounded-md transition-colors" title="Download backup">
                <i data-lucide="download" class="w-4 h-4"></i>
                Export CSV
            </button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Column: Input Form -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4 text-indigo-600"></i>
                    Log Activity
                </h2>
                <form id="logForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Date</label>
                            <input type="date" id="dateInput" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Start Time</label>
                            <input type="time" id="startTimeInput" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Category</label>
                        <div class="flex gap-2">
                            <select id="categoryInput" onchange="handleCategoryChange()" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                <!-- Options populated by JS -->
                            </select>
                            <button type="button" onclick="toggleCategoryManager()" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 transition-colors">
                                <i data-lucide="filter" class="w-4 h-4" id="catMgrIcon"></i>
                            </button>
                        </div>
                        
                        <!-- Hidden Category Manager -->
                        <div id="categoryManager" class="hidden mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200 fade-in">
                            <label class="text-xs text-slate-500 mb-1 block">Add New Category</label>
                            <div class="flex gap-2">
                                <input type="text" id="newCategoryInput" class="flex-1 border border-slate-300 rounded px-2 py-1 text-sm" placeholder="e.g. Crisis Mgmt">
                                <button type="button" onclick="addCategory()" class="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">Add</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Description</label>
                        <textarea id="descInput" required rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" placeholder="What did you work on?"></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Duration (Hours)</label>
                        <input type="number" id="hoursInput" step="0.25" min="0.25" value="1" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition-all shadow-sm active:transform active:scale-95">
                        Log Entry
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column: Dashboard & Logs -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Dashboard Header/Filters -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex items-center gap-2">
                    <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg" id="headerIcon">
                        <!-- Icon changes via JS -->
                    </div>
                    <div>
                        <h2 class="font-bold text-slate-800" id="headerTitle">This Week</h2>
                        <p class="text-xs text-slate-500">
                            Total: <span class="font-bold text-indigo-600 text-sm" id="totalHoursDisplay">0.0 hrs</span>
                        </p>
                    </div>
                </div>

                <div class="flex bg-slate-100 p-1 rounded-lg">
                    <button onclick="setTimeRange('week')" id="btnWeek" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all">Week</button>
                    <button onclick="setTimeRange('month')" id="btnMonth" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all">Month</button>
                    <button onclick="setTimeRange('all')" id="btnAll" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all">All</button>
                </div>
            </div>

            <!-- Visuals -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Breakdown Card -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i> Category Breakdown
                    </h3>
                    <div class="space-y-3" id="breakdownContainer">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Quick Stats Card -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center">
                    <h3 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-4 h-4"></i> Executive Summary
                    </h3>
                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-100">
                        <p class="text-xs text-slate-500 mb-2">Top Focus Area</p>
                        <div class="text-lg font-bold text-indigo-700 line-clamp-2" id="topFocusArea">N/A</div>
                        <p class="text-xs text-slate-400 mt-1" id="topFocusStat"></p>
                    </div>
                </div>
            </div>

            <!-- Task List / Calendar Container -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div class="flex items-center gap-4">
                        <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                            <i data-lucide="list" class="w-4 h-4"></i> Activity Log
                        </h3>
                        <div class="flex bg-white border border-slate-200 rounded-lg p-0.5">
                            <button onclick="setViewMode('list')" id="viewListBtn" class="p-1.5 rounded text-indigo-600 bg-indigo-50"><i data-lucide="list" class="w-4 h-4"></i></button>
                            <button onclick="setViewMode('calendar')" id="viewCalendarBtn" class="p-1.5 rounded text-slate-400 hover:text-slate-600"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <span class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full" id="entryCount">0 Entries</span>
                </div>
                
                <!-- LIST VIEW -->
                <div id="listViewContainer" class="max-h-[500px] overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 sticky top-0 text-slate-500 font-medium text-xs uppercase shadow-sm z-10">
                            <tr>
                                <th class="px-5 py-3">Date</th>
                                <th class="px-5 py-3">Time</th>
                                <th class="px-5 py-3">Category</th>
                                <th class="px-5 py-3">Task</th>
                                <th class="px-5 py-3 text-right">Hours</th>
                                <th class="px-5 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="taskTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                    <div id="emptyState" class="hidden p-8 text-center text-slate-400 text-sm">
                        No entries found for this time range.
                    </div>
                </div>

                <!-- CALENDAR VIEW -->
                <div id="calendarViewContainer" class="hidden flex flex-col h-[600px]">
                    <!-- Calendar Controls -->
                    <div class="flex items-center justify-between px-4 py-2 bg-slate-50 border-b border-slate-200">
                        <button onclick="changeCalendarDay(-1)" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <div class="text-sm font-bold text-slate-700" id="calendarCurrentDate">Today</div>
                        <button onclick="changeCalendarDay(1)" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                    
                    <!-- Scrollable Timeline -->
                    <div class="overflow-y-auto flex-1 relative bg-white" id="calendarTimeline">
                        <!-- Grid and Events injected here -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Application Logic -->
    <script>
        // --- Configuration & Data ---
        const DEFAULT_CATEGORIES = [
            "CX Comms Testing (monthly)",
            "BSA/AML Testing (monthly)",
            "Macros Testing (monthly)",
            "Blog -- Help Center/Resource center (monthly)",
            "Affiliate testing (initial review, monthly)",
            "Continuous email testing (initial review, monthly)",
            "Drafting issues from testing",
            "Set up monthly and quarterly reporting decks and transfer issues to Asana",
            "Issues Validation",
            "Asana Issues management (adding new issues after reporting)",
            "Process Flow, Reg, or Additional Testing",
            "UDAAP marketing repository",
            "Monthly/Quarterly reporting",
            "Complaints handling",
            "Complaint reporting",
            "Website Audit (Quarterly)",
            "Marketing Audit (annual - comprehensive)",
            "Governance Audit (annual - comprehensive)",
            "Documentation not accounted for / cushion",
            "Meetings",
            "One-offs / special projects",
            "Lunch"
        ];

        // State
        let tasks = JSON.parse(localStorage.getItem('worklog_tasks_v3')) || [];
        // Migration: Add startTime if missing
        tasks = tasks.map(t => ({...t, startTime: t.startTime || "09:00"}));
        
        // Updated key to v3 to include Lunch in defaults for existing users
        let categories = JSON.parse(localStorage.getItem('worklog_categories_v3')) || DEFAULT_CATEGORIES;
        let timeRange = 'week'; // week, month, all
        let viewMode = 'list'; // 'list', 'calendar'
        let calendarDate = new Date(); // Date currently viewed in calendar

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default inputs to LOCAL time now
            const now = new Date();
            // toLocaleDateString('en-CA') returns YYYY-MM-DD in local time
            document.getElementById('dateInput').value = getLocalIsoDate(now);
            
            // Default time to next nearest 15 min slot or current time
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(Math.floor(now.getMinutes()/15)*15).padStart(2, '0');
            document.getElementById('startTimeInput').value = `${hours}:${minutes}`;

            // Initial Render
            renderCategoryOptions();
            updateUI();
            
            lucide.createIcons();
        });

        // --- Helper: Get YYYY-MM-DD string in Local Time (fixes offset bugs) ---
        function getLocalIsoDate(dateObj) {
            // Fallback for browsers not supporting en-CA, though widely supported
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // --- Core Logic ---

        function save() {
            localStorage.setItem('worklog_tasks_v3', JSON.stringify(tasks));
            localStorage.setItem('worklog_categories_v3', JSON.stringify(categories));
            updateUI();
        }

        function getDateRangeCutoff() {
            const now = new Date();
            // Start of today in local time
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            if (timeRange === 'week') {
                const day = startOfDay.getDay(); // 0 (Sun) - 6 (Sat)
                // Adjust so week starts on Monday (1)
                const diff = startOfDay.getDate() - day + (day === 0 ? -6 : 1); 
                const startOfWeek = new Date(startOfDay);
                startOfWeek.setDate(diff);
                return startOfWeek;
            } else if (timeRange === 'month') {
                return new Date(now.getFullYear(), now.getMonth(), 1);
            }
            return new Date(0); // All time
        }

        function getFilteredTasks() {
            const cutoff = getDateRangeCutoff();
            return tasks
                .filter(t => {
                    // Fix: Parse YYYY-MM-DD as local time components, not UTC
                    const [y, m, d] = t.date.split('-').map(Number);
                    const taskDate = new Date(y, m - 1, d); // Local midnight
                    return taskDate >= cutoff;
                })
                .sort((a, b) => {
                    // Sort by date then time
                    if (a.date !== b.date) {
                        return b.date.localeCompare(a.date);
                    }
                    return b.startTime.localeCompare(a.startTime);
                });
        }

        // --- Rendering ---

        function updateUI() {
            const filtered = getFilteredTasks();
            renderStats(filtered);
            renderTable(filtered);
            renderCalendar();
            renderControls();
        }

        function renderCategoryOptions() {
            const select = document.getElementById('categoryInput');
            // Preserve selection if possible
            const current = select.value;
            select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            if (categories.includes(current)) select.value = current;
        }

        function handleCategoryChange() {
            const cat = document.getElementById('categoryInput').value;
            if (cat === 'Lunch') {
                document.getElementById('hoursInput').value = "1";
                document.getElementById('descInput').placeholder = "Lunch break";
            } else {
                document.getElementById('descInput').placeholder = "What did you work on?";
            }
        }

        function renderControls() {
            // Time Range Tabs
            ['week', 'month', 'all'].forEach(range => {
                const btn = document.getElementById(`btn${range.charAt(0).toUpperCase() + range.slice(1)}`);
                if (range === timeRange) {
                    btn.className = "px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-white text-indigo-600 shadow-sm";
                } else {
                    btn.className = "px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-700";
                }
            });

            // View Mode Toggle
            const btnList = document.getElementById('viewListBtn');
            const btnCal = document.getElementById('viewCalendarBtn');
            const listContainer = document.getElementById('listViewContainer');
            const calContainer = document.getElementById('calendarViewContainer');

            if (viewMode === 'list') {
                btnList.className = "p-1.5 rounded text-indigo-600 bg-indigo-50 transition-colors";
                btnCal.className = "p-1.5 rounded text-slate-400 hover:text-slate-600 transition-colors";
                listContainer.classList.remove('hidden');
                calContainer.classList.add('hidden');
            } else {
                btnList.className = "p-1.5 rounded text-slate-400 hover:text-slate-600 transition-colors";
                btnCal.className = "p-1.5 rounded text-indigo-600 bg-indigo-50 transition-colors";
                listContainer.classList.add('hidden');
                calContainer.classList.remove('hidden');
            }

            // Header Icon
            const headerTitle = document.getElementById('headerTitle');
            const headerIcon = document.getElementById('headerIcon');
            if (timeRange === 'week') {
                headerTitle.textContent = "This Week";
                headerIcon.innerHTML = `<i data-lucide="clock" class="w-5 h-5"></i>`;
            } else if (timeRange === 'month') {
                headerTitle.textContent = "This Month";
                headerIcon.innerHTML = `<i data-lucide="calendar" class="w-5 h-5"></i>`;
            } else {
                headerTitle.textContent = "All Time";
                headerIcon.innerHTML = `<i data-lucide="archive" class="w-5 h-5"></i>`;
            }
            lucide.createIcons();
        }

        function renderStats(filteredTasks) {
            const totalHours = filteredTasks.reduce((acc, curr) => acc + parseFloat(curr.hours), 0);
            document.getElementById('totalHoursDisplay').textContent = `${totalHours.toFixed(1)} hrs`;

            const byCategory = filteredTasks.reduce((acc, curr) => {
                acc[curr.category] = (acc[curr.category] || 0) + parseFloat(curr.hours);
                return acc;
            }, {});

            const categoryArray = Object.entries(byCategory)
                .map(([name, hours]) => ({
                    name,
                    hours,
                    percentage: totalHours > 0 ? (hours / totalHours) * 100 : 0
                }))
                .sort((a, b) => b.hours - a.hours);

            const breakdownContainer = document.getElementById('breakdownContainer');
            if (categoryArray.length === 0) {
                breakdownContainer.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm italic">No data for this period</div>`;
            } else {
                breakdownContainer.innerHTML = categoryArray.slice(0, 5).map(cat => `
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-slate-700 truncate w-3/4" title="${cat.name}">${cat.name}</span>
                            <span class="text-slate-500">${cat.hours.toFixed(1)}h (${Math.round(cat.percentage)}%)</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2">
                            <div class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: ${cat.percentage}%"></div>
                        </div>
                    </div>
                `).join('');
            }

            const topFocusArea = document.getElementById('topFocusArea');
            const topFocusStat = document.getElementById('topFocusStat');
            
            if (categoryArray.length > 0) {
                topFocusArea.textContent = categoryArray[0].name;
                topFocusStat.textContent = `Consumes ${Math.round(categoryArray[0].percentage)}% of your time`;
            } else {
                topFocusArea.textContent = "N/A";
                topFocusStat.textContent = "";
            }
        }

        function renderTable(filteredTasks) {
            const tbody = document.getElementById('taskTableBody');
            const emptyState = document.getElementById('emptyState');
            const entryCount = document.getElementById('entryCount');

            entryCount.textContent = `${filteredTasks.length} Entries`;

            if (filteredTasks.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                tbody.innerHTML = filteredTasks.map(task => {
                    // Date parsing fix for table display
                    const [y, m, d] = task.date.split('-').map(Number);
                    const dateObj = new Date(y, m - 1, d);
                    const dateStr = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric', weekday: 'short' });
                    
                    return `
                    <tr class="hover:bg-slate-50 transition-colors group">
                        <td class="px-5 py-3 text-slate-500 whitespace-nowrap w-24">${dateStr}</td>
                        <td class="px-5 py-3 text-slate-500 whitespace-nowrap w-20 text-xs font-mono">${task.startTime}</td>
                        <td class="px-5 py-3 w-48">
                            <span class="inline-block px-2 py-1 rounded-md bg-indigo-50 text-indigo-700 text-xs font-medium truncate max-w-[140px]" title="${task.category}">${task.category}</span>
                        </td>
                        <td class="px-5 py-3 text-slate-700">${task.description}</td>
                        <td class="px-5 py-3 text-right font-medium text-slate-900 w-24">${parseFloat(task.hours).toFixed(2)}</td>
                        <td class="px-5 py-3 text-right w-16">
                            <button onclick="deleteTask('${task.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-1" title="Delete entry">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }).join('');
                
                lucide.createIcons();
            }
        }

        function renderCalendar() {
            if (viewMode !== 'calendar') return;

            const container = document.getElementById('calendarTimeline');
            const dateLabel = document.getElementById('calendarCurrentDate');
            
            // Format current calendar date
            dateLabel.textContent = calendarDate.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

            // Generate Time Slots (7 AM to 8 PM)
            const startHour = 7;
            const endHour = 20;
            const pxPerHour = 80; 
            const totalHeight = (endHour - startHour + 1) * pxPerHour;

            let html = `<div class="relative w-full" style="height: ${totalHeight}px;">`;

            // Draw Grid Lines (Every Hour and 15 mins)
            for (let h = startHour; h <= endHour; h++) {
                const top = (h - startHour) * pxPerHour;
                // Hour line
                html += `
                    <div class="absolute w-full calendar-grid-line flex items-center" style="top: ${top}px; height: ${pxPerHour}px;">
                        <span class="text-xs text-slate-400 w-12 text-right pr-2 -mt-[${pxPerHour}px]">${h > 12 ? h-12 + ' PM' : h + ' AM'}</span>
                    </div>
                `;
                // 15, 30, 45 min lines (dashed)
                for (let m = 15; m < 60; m+=15) {
                    const subTop = top + (m/60 * pxPerHour);
                    html += `<div class="absolute w-full calendar-grid-line-minor left-12 right-0" style="top: ${subTop}px;"></div>`;
                }
            }

            // Draw Events
            // Use local ISO date string for comparison to avoid timezone mismatch
            const currentIsoDate = getLocalIsoDate(calendarDate);
            const dayTasks = tasks.filter(t => t.date === currentIsoDate);

            dayTasks.forEach(task => {
                const [h, m] = task.startTime.split(':').map(Number);
                if (h < startHour || h > endHour) return; // Skip if out of view bounds (simple approach)

                const startMinutesFromBase = ((h - startHour) * 60) + m;
                const topPx = (startMinutesFromBase / 60) * pxPerHour;
                const heightPx = parseFloat(task.hours) * pxPerHour;
                
                // Color coding for Lunch
                const isLunch = task.category === 'Lunch';
                const bgClass = isLunch ? 'bg-orange-100' : 'bg-indigo-100';
                const borderClass = isLunch ? 'border-orange-500' : 'border-indigo-500';
                const textClass = isLunch ? 'text-orange-900' : 'text-indigo-900';

                html += `
                    <div class="absolute left-14 right-4 rounded ${bgClass} border-l-4 ${borderClass} px-3 py-1 text-xs overflow-hidden hover:z-10 hover:shadow-md transition-all group" 
                         style="top: ${topPx}px; height: ${Math.max(heightPx, 20)}px;">
                        <div class="flex justify-between items-start">
                            <span class="font-bold ${textClass} truncate">${task.category}</span>
                            <button onclick="deleteTask('${task.id}')" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="${textClass} truncate opacity-80">${task.description}</div>
                        <div class="${textClass} text-[10px] mt-0.5">${task.hours}h</div>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- Interaction Handlers ---

        document.getElementById('logForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const desc = document.getElementById('descInput').value;
            const hours = parseFloat(document.getElementById('hoursInput').value);
            const date = document.getElementById('dateInput').value;
            const category = document.getElementById('categoryInput').value;
            const startTime = document.getElementById('startTimeInput').value;

            if (!desc || hours <= 0 || !date || !startTime) return;

            tasks.push({
                id: crypto.randomUUID(),
                timestamp: Date.now(),
                date,
                startTime,
                category,
                description: desc,
                hours
            });

            // Reset specific fields
            document.getElementById('descInput').value = '';
            // Auto-increment time for next task?
            const [h, m] = startTime.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(h);
            endDate.setMinutes(m + (hours * 60));
            const newH = String(endDate.getHours()).padStart(2, '0');
            const newM = String(endDate.getMinutes()).padStart(2, '0');
            document.getElementById('startTimeInput').value = `${newH}:${newM}`;
            
            // Reset hours if it was set to Lunch default
            if (category === 'Lunch') {
                 document.getElementById('hoursInput').value = '1'; 
            }
            
            save();
        });

        function deleteTask(id) {
            if(confirm("Are you sure you want to delete this entry?")) {
                tasks = tasks.filter(t => t.id !== id);
                save();
            }
        }

        function setTimeRange(range) {
            timeRange = range;
            updateUI();
        }

        function setViewMode(mode) {
            viewMode = mode;
            // Sync calendar date with input date if switching
            if (mode === 'calendar') {
                const inputDate = document.getElementById('dateInput').value;
                // Parse local input string to local date
                const [y, m, d] = inputDate.split('-').map(Number);
                if (inputDate) calendarDate = new Date(y, m-1, d);
            }
            updateUI();
        }

        function changeCalendarDay(delta) {
            calendarDate.setDate(calendarDate.getDate() + delta);
            // Sync input form too for convenience
            const iso = getLocalIsoDate(calendarDate);
            document.getElementById('dateInput').value = iso;
            updateUI();
        }

        function toggleCategoryManager() {
            const mgr = document.getElementById('categoryManager');
            mgr.classList.toggle('hidden');
        }

        function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const newCat = input.value.trim();
            if (newCat && !categories.includes(newCat)) {
                categories.push(newCat);
                renderCategoryOptions();
                document.getElementById('categoryInput').value = newCat;
                input.value = '';
                save();
            }
        }

        function exportCSV() {
            const filtered = getFilteredTasks();
            const headers = ["Date", "Start Time", "Category", "Description", "Hours"];
            const csvContent = [
                headers.join(","),
                ...filtered.map(t => 
                    `${t.date},${t.startTime},"${t.category}","${t.description.replace(/"/g, '""')}",${t.hours}`
                )
            ].join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `worklog_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- CSV IMPORT LOGIC ---
        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                processCSV(text);
                input.value = ''; // Reset input to allow same file selection again
            };
            reader.readAsText(file);
        }

        function processCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return alert("Invalid CSV format or empty file");

            const header = lines[0].toLowerCase();
            const hasStartTime = header.includes("start time");
            
            let importedCount = 0;
            
            // Skip header (i=1)
            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVRow(lines[i]);
                if (row.length < 4) continue;

                let date, startTime, category, description, hours;

                if (hasStartTime) {
                     // Date, Start Time, Category, Description, Hours
                     [date, startTime, category, description, hours] = row;
                } else {
                     // Legacy Support: Date, Category, Description, Hours
                     [date, category, description, hours] = row;
                     startTime = "09:00"; 
                }

                if (!date || !description || !hours) continue;

                // Duplicate Check (to prevent double importing backups)
                const isDuplicate = tasks.some(t => 
                    t.date === date && 
                    t.startTime === startTime && 
                    t.description === description &&
                    t.hours == hours // loose equality
                );

                if (!isDuplicate) {
                    tasks.push({
                        id: crypto.randomUUID(),
                        timestamp: Date.now(),
                        date,
                        startTime,
                        // Clean quotes if regex missed them (unlikely with parseCSVRow but safe)
                        category: category.trim(), 
                        description: description.trim(),
                        hours: parseFloat(hours)
                    });
                    importedCount++;
                }
            }

            if (importedCount > 0) {
                save();
                alert(`Successfully imported ${importedCount} entries.`);
            } else {
                alert("No new entries found. Duplicate entries were skipped.");
            }
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuote = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                    if (inQuote && row[i+1] === '"') {
                        current += '"';
                        i++; // Skip the escaped quote
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

    </script>
</body>
</html>
